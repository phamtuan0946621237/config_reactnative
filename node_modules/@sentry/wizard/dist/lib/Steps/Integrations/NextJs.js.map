{"version":3,"file":"NextJs.js","sourceRoot":"","sources":["../../../../lib/Steps/Integrations/NextJs.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport { Answers, prompt } from 'inquirer';\nimport * as _ from 'lodash';\nimport * as path from 'path';\n\nimport { Args } from '../../Constants';\nimport { debug, dim, green, l, nl, red } from '../../Helper/Logging';\nimport { SentryCli } from '../../Helper/SentryCli';\nimport { BaseIntegration } from './BaseIntegration';\n\nconst MIN_NEXTJS_VERSION = '10.0.0';\nconst PROPERTIES_FILENAME = 'sentry.properties';\nconst CONFIG_FILENAME = 'next.config.js';\nconst MERGEABLE_CONFIG_FILENAME = `_${CONFIG_FILENAME}`;\n\nconst CODE_EXAMPLE = `import * as Sentry from '@sentry/nextjs';`;\n\nlet appPackage: any = {};\n\nfunction printExample(example: string, title: string = ''): void {\n  if (title) {\n    l(title);\n  }\n\n  nl();\n  dim(example.replace(/^/gm, '    '));\n  nl();\n}\n\ntry {\n  appPackage = require(path.join(process.cwd(), 'package.json'));\n} catch {\n  // We don't need to have this\n}\n\nexport class NextJs extends BaseIntegration {\n  protected _sentryCli: SentryCli;\n\n  constructor(protected _argv: Args) {\n    super(_argv);\n    this._sentryCli = new SentryCli(this._argv);\n  }\n\n  public async emit(answers: Answers): Promise<Answers> {\n    const dsn = _.get(answers, ['config', 'dsn', 'public'], null);\n    nl();\n\n    const sentryCliProps = this._sentryCli.convertAnswersToProperties(answers);\n    fs.writeFileSync(\n      `./${PROPERTIES_FILENAME}`,\n      this._sentryCli.dumpProperties(sentryCliProps),\n    );\n    green(`Successfully created sentry.properties`);\n    nl();\n\n    const webpackConfig = path.join(\n      __dirname,\n      '..',\n      '..',\n      '..',\n      'NextJs',\n      CONFIG_FILENAME,\n    );\n\n    if (fs.existsSync(webpackConfig)) {\n      this._createNextConfig(webpackConfig, dsn);\n    } else {\n      debug(\n        `Couldn't find ${webpackConfig}, probably because you run from src`,\n      );\n      nl();\n    }\n\n    printExample(\n      CODE_EXAMPLE.replace('___DSN___', dsn),\n      'You can import Sentry like this and start using it:',\n    );\n\n    l(\n      'For more information, see https://docs.sentry.io/platforms/javascript/guides/nextjs/',\n    );\n    nl();\n\n    return {};\n  }\n\n  public async shouldConfigure(_answers: Answers): Promise<Answers> {\n    if (this._shouldConfigure) {\n      return this._shouldConfigure;\n    }\n\n    nl();\n\n    let userAnswers: Answers = { continue: true };\n    if (!this._checkDep('next', true) && !this._argv.quiet) {\n      userAnswers = await prompt({\n        message:\n          'There were errors during your project checkup, do you still want to continue?',\n        name: 'continue',\n        default: false,\n        type: 'confirm',\n      });\n    }\n\n    nl();\n\n    if (!userAnswers['continue']) {\n      throw new Error('Please install the required dependencies to continue.');\n    }\n\n    this._shouldConfigure = Promise.resolve({ nextjs: true });\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    return this.shouldConfigure;\n  }\n\n  private _createNextConfig(webpackConfig: string, dsn: any): void {\n    let showMergeMsg = false;\n    let dstConfigFilepath = path.posix.join(process.cwd(), CONFIG_FILENAME);\n    if (fs.existsSync(dstConfigFilepath)) {\n      dstConfigFilepath = path.posix.join(\n        process.cwd(),\n        MERGEABLE_CONFIG_FILENAME,\n      );\n      showMergeMsg = true;\n    }\n\n    const content = fs\n      .readFileSync(webpackConfig)\n      .toString()\n      .replace('___DSN___', dsn);\n    fs.writeFileSync(dstConfigFilepath, content);\n\n    if (showMergeMsg) {\n      red(\n        'You already have a next.config.js file in your project.\\n' +\n          `There's a new ${MERGEABLE_CONFIG_FILENAME} file with the Sentry config; ` +\n          'please merge this file to your existing config file.',\n      );\n      nl();\n    }\n  }\n\n  private _checkDep(packageName: string, minVersion?: boolean): boolean {\n    const depVersion = parseInt(\n      _.get(appPackage, ['dependencies', packageName], '0').replace(/\\D+/g, ''),\n      10,\n    );\n    const devDepVersion = parseInt(\n      _.get(appPackage, ['devDependencies', packageName], '0').replace(\n        /\\D+/g,\n        '',\n      ),\n      10,\n    );\n\n    const parsedVersion = parseInt(MIN_NEXTJS_VERSION.replace(/\\D+/g, ''));\n\n    if (\n      !_.get(appPackage, `dependencies.${packageName}`, false) &&\n      !_.get(appPackage, `devDependencies.${packageName}`, false)\n    ) {\n      red(`✗ ${packageName} isn't in your dependencies`);\n      red(`  please install it with yarn/npm`);\n      return false;\n    } else if (\n      // When the Next.js dependency is `latest` the int parsing will output\n      // in a NaN. Don't support this.\n      isNaN(depVersion) ||\n      isNaN(devDepVersion)\n    ) {\n      red(\n        \"✗ `latest` version for NextJS isn't supported, replace it with the actual version number.\",\n      );\n      nl();\n      return false;\n    } else if (\n      minVersion &&\n      depVersion < parsedVersion &&\n      devDepVersion < parsedVersion\n    ) {\n      red(\n        `✗ Your installed version of ${packageName} is not supported, >${MIN_NEXTJS_VERSION} needed`,\n      );\n      return false;\n    } else {\n      if (minVersion) {\n        green(`✓ ${packageName} > ${MIN_NEXTJS_VERSION} is installed`);\n      } else {\n        green(`✓ ${packageName} is installed`);\n      }\n      return true;\n    }\n  }\n}\n"]}